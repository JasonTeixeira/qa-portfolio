name: QA Metrics â†’ AWS (OIDC)

on:
  workflow_dispatch:

# This is a reference workflow you can copy into each QA repo.
# It demonstrates GitHub OIDC -> AWS role assumption -> S3 upload.

permissions:
  id-token: write
  contents: read

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_QA_METRICS_ROLE_ARN }}
          aws-region: us-east-1

      - name: Ensure qa-metrics.json exists
        run: |
          test -f qa-metrics.json || (echo "qa-metrics.json missing" && exit 1)

      - name: Upload to S3
        env:
          BUCKET: ${{ secrets.AWS_QA_METRICS_BUCKET }}
          PREFIX: metrics
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          RUN_ID: ${{ github.run_id }}
        run: |
          key="$PREFIX/$REPO/$BRANCH/$RUN_ID.json"
          aws s3 cp qa-metrics.json "s3://$BUCKET/$key"
          echo "Uploaded: s3://$BUCKET/$key"
